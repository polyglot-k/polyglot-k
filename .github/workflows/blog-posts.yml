name: Latest blog post workflow
on:
  schedule:
    - cron: '0 0 * * *' # ë§¤ì¼ ìì •
  workflow_dispatch:

jobs:
  update-readme-with-blog:
    name: Update README with [NEW] tag
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install feedparser

      - name: Update README
        shell: python
        run: |
          import feedparser
          from datetime import datetime, timedelta
          import re

          # ì„¤ì •
          rss_url = "https://polyglot-k.github.io/rss.xml"
          readme_path = "README.md"
          max_posts = 5

          # í”¼ë“œ ê°€ì ¸ì˜¤ê¸°
          feed = feedparser.parse(rss_url)
          entries = feed.entries[:max_posts]

          new_content = ""
          now = datetime.now()

          for entry in entries:
              # ë‚ ì§œ íŒŒì‹± (RSSë§ˆë‹¤ í˜•ì‹ì´ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)
              try:
                  published = datetime(*entry.published_parsed[:6])
                  # 3ì¼(72ì‹œê°„) ì´ë‚´ì¸ì§€ í™•ì¸
                  is_new = (now - published) <= timedelta(days=3)
              except:
                  is_new = False

              tag = "[NEW] " if is_new else ""
              date_str = published.strftime("%Y.%m.%d")
              title = entry.title
              url = entry.link
              
              # í…œí”Œë¦¿ ì ìš©
              new_content += f"- ğŸ“ {tag}[{title}]({url}) <span style='color: gray; font-size: 80%;'>{date_str}</span>\n"

          # README ì—…ë°ì´íŠ¸
          with open(readme_path, "r", encoding="utf-8") as f:
              readme = f.read()

          # ì™€ ì‚¬ì´ êµì²´
          start_tag = ""
          end_tag = ""
          
          pattern = f"{start_tag}.*?{end_tag}"
          replacement = f"{start_tag}\n{new_content}{end_tag}"
          
          updated_readme = re.sub(pattern, replacement, readme, flags=re.DOTALL)

          with open(readme_path, "w", encoding="utf-8") as f:
              f.write(updated_readme)

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "Update README with latest blog posts" || echo "No changes to commit"
          git push
