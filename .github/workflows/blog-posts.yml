name: Latest blog post workflow

on:
  schedule:
    - cron: '0 0 * * *' # Îß§Ïùº ÏûêÏ†ï (UTC)
  workflow_dispatch:

jobs:
  update-readme-with-blog:
    name: Update README
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install feedparser

      - name: Update README with latest blog posts
        shell: python
        run: |
          import feedparser
          from datetime import datetime, timedelta
          import time
          import re

          RSS_URL = "https://polyglot-k.github.io/rss.xml"
          MAX_POSTS = 5
          NEW_DAYS = 3

          START_MARKER = "<!-- BLOG-POST-LIST:START -->"
          END_MARKER = "<!-- BLOG-POST-LIST:END -->"

          feed = feedparser.parse(RSS_URL)

          now = datetime.utcnow()
          threshold = now - timedelta(days=NEW_DAYS)

          posts_md = []

          for entry in feed.entries[:MAX_POSTS]:
              published = datetime.fromtimestamp(
                  time.mktime(entry.published_parsed)
              )
              date_str = published.strftime("%Y.%m.%d")

              new_tag = (
                  "<b style='color: #2ea44f;'>[NEW]</b> "
                  if published >= threshold
                  else ""
              )

              posts_md.append(
                  f" - üìù {new_tag}[{entry.title}]({entry.link}) "
                  f"<span style='color: gray; font-size: 80%;'>{date_str}</span>"
              )

          new_block = "\n".join(posts_md)

          with open("README.md", "r", encoding="utf-8") as f:
              readme = f.read()

          if START_MARKER not in readme or END_MARKER not in readme:
              raise RuntimeError(
                  "README.mdÏóê BLOG-POST-LIST ÎßàÏª§Í∞Ä ÏóÜÏäµÎãàÎã§."
              )

          pattern = re.compile(
              rf"{re.escape(START_MARKER)}.*?{re.escape(END_MARKER)}",
              re.DOTALL
          )

          replacement = (
              f"{START_MARKER}\n\n"
              f"{new_block}\n"
              f"{END_MARKER}"
          )

          updated = pattern.sub(replacement, readme)

          with open("README.md", "w", encoding="utf-8") as f:
              f.write(updated)

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "Update README with latest blog posts" || echo "No changes to commit"
          git push
